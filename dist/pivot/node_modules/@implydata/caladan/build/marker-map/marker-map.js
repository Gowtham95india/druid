"use strict";var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var React=require("react");var L=require("leaflet");var react_leaflet_1=require("react-leaflet");var svg_icon_1=require("../svg-icon/svg-icon");var little_pictures_1=require("@implydata/little-pictures");var START_POSITION=[19.642587534,20.7421875];var MAX_BOUNDS=new L.LatLngBounds([new L.LatLng(83.82994542398042,-166.640625),new L.LatLng(-78.9039293885709,195.82031249999997)]);var START_ZOOM=2;var MarkerMap=function(_super){__extends(MarkerMap,_super);function MarkerMap(){var _this=this;_super.call(this);this.isDragging=false;this.hasInitialized=false;this.state={zoom:START_ZOOM};this.utils={latLngToPoint:function(latLng){return _this.getMap().latLngToContainerPoint(latLng)}}}MarkerMap.prototype.onZoomEnd=function(event){var onZoom=this.props.onZoom;var zoom=this.getMap().getZoom();this.setState({zoom:zoom});if(onZoom)onZoom(zoom,this.utils)};MarkerMap.prototype.onDragStart=function(){this.isDragging=true};MarkerMap.prototype.onDragEnd=function(){this.isDragging=false;this.setState({})};MarkerMap.prototype.onDrag=function(event){var onPan=this.props.onPan;if(onPan)onPan(this.utils)};MarkerMap.prototype.onMarkerOver=function(item,event){var onMarkerOver=this.props.onMarkerOver;if(onMarkerOver)onMarkerOver(item,this.utils)};MarkerMap.prototype.onMarkerClick=function(item,event){var onMarkerClick=this.props.onMarkerClick;if(onMarkerClick)onMarkerClick(item,this.utils)};MarkerMap.prototype.onMarkerOut=function(item,event){var onMarkerOut=this.props.onMarkerOut;if(this.isDragging)return;if(onMarkerOut)onMarkerOut(item,this.utils)};MarkerMap.prototype.getMap=function(){if(!this.refs["map"])return null;return this.refs["map"].leafletElement};MarkerMap.prototype.getScaleFromMarkers=function(markers,zoom){var m=Number.POSITIVE_INFINITY;var M=Number.NEGATIVE_INFINITY;markers.forEach(function(d){if(d.value>M)M=d.value;if(d.value<m)m=d.value});if(m===M)return function(x){return 5*zoom};var a=1*zoom;var b=10*zoom;return function(x){return a+(x-m)*(b-a)/(M-m)}};MarkerMap.prototype.renderMarkers=function(zoom){var markers=this.props.markers;var scale=this.getScaleFromMarkers(markers,zoom);var elements=[];for(var i=0;i<markers.length;i++){var m=markers[i];elements.push(React.createElement(react_leaflet_1.CircleMarker,{key:i,center:m.latLng,color:"hsla(201, 81%, 49%, 1.00)",fillColor:"hsla(201, 81%, 49%, 1.00)",fillOpacity:m.additionalOptions?m.additionalOptions.fillOpacity:1,radius:scale(m.value),onMouseover:this.onMarkerOver.bind(this,m),onMouseout:this.onMarkerOut.bind(this,m),onClick:this.onMarkerClick.bind(this,m),stroke:false}));if(m.outerCircle){elements.push(React.createElement(react_leaflet_1.CircleMarker,{key:"outer-"+i,center:m.latLng,color:"hsla(201, 81%, 49%, 1.00)",fillOpacity:0,radius:scale(m.value)+4,weight:1,dashArray:[3,4]}))}}return elements};MarkerMap.prototype.componentDidUpdate=function(){var onAppear=this.props.onAppear;if(!this.hasInitialized&&onAppear&&this.getMap()){onAppear(this.utils);this.hasInitialized=true}};MarkerMap.prototype.onMapClick=function(event){var onMapClick=this.props.onMapClick;if(onMapClick)onMapClick(this.utils)};MarkerMap.prototype.onReset=function(event){event.preventDefault();this.getMap().setView(START_POSITION,START_ZOOM);this.setState({zoom:START_ZOOM})};MarkerMap.prototype.renderResetButton=function(){return React.createElement("div",{className:"reset-control leaflet-bar"},React.createElement("a",{onClick:this.onReset.bind(this),href:"#",title:"Reset zoom"},React.createElement(svg_icon_1.SvgIcon,{svg:little_pictures_1.RESET})))};MarkerMap.prototype.render=function(){var _a=this.props,disablePan=_a.disablePan,disableZoom=_a.disableZoom;var zoom=this.state.zoom;return React.createElement("div",{className:"marker-map"},React.createElement(react_leaflet_1.Map,{ref:"map",dragging:!disablePan,touchZoom:!disableZoom,doubleClickZoom:!disableZoom,scrollWheelZoom:!disableZoom,boxZoom:!disableZoom,keyboard:!disableZoom,zoomControl:!disableZoom,center:START_POSITION,maxBounds:MAX_BOUNDS,zoom:zoom,minZoom:2,onZoomend:this.onZoomEnd.bind(this),onDragstart:this.onDragStart.bind(this),onDragend:this.onDragEnd.bind(this),onMove:this.onDrag.bind(this),onClick:this.onMapClick.bind(this)},React.createElement(react_leaflet_1.TileLayer,{url:"http://{s}.tile.osm.org/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}),this.renderMarkers(zoom)),disableZoom&&disablePan?null:this.renderResetButton())};return MarkerMap}(React.Component);exports.MarkerMap=MarkerMap;