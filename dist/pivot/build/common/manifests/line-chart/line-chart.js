"use strict";var __extends=this&&this.__extends||function(e,t){for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i];function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)};var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var index_1=require("../../models/index");var manifest_1=require("../../models/manifest/manifest");var index_2=require("../index");var LineChartManifest=function(e){__extends(t,e);function t(){e.apply(this,arguments);this.name="line-chart";this.title="Line Chart"}t.prototype.ensureSplitOrder=function(e,t,i,n){var r=n.getSplitableDimensions();if(e.toArray().every(function(e){return e.isBucketed()})){var s=e.splitCombines.filter(function(e){return e.getDimension(r).getKind()==="time"});var a=null;if(s.length===1)a=s[0];if(s.length>1){var l=s.find(function(e){return n.specialTimeDimension===e.dimension});a=l||s[0]}if(a&&t!==a){return{primarySplit:a,colorSplit:t}}}return{primarySplit:t,colorSplit:i}};t.prototype.summonBucketableSplit=function(e,t,i){var n=e.isSortOnSelfAscending();var r=e.limitAction,s=e.bucketAction;if(n&&!r&&s)return e;var a=e.dimension;if(!s)e=e.addBucketGivenFilter(i,t);if(!n)e=e.changeSortAction(plywood_1.Expression._.sort(plywood_1.$(a),plywood_1.SortExpression.ASCENDING));if(r)e=e.changeLimitAction(null);return e};t.prototype.summon=function(e,t,i,n,r){var s=this;var a=e.getSplitableDimensions();var l=t.splitCombines.find(function(e){return e.isBucketable(a)});var o=function(e){return{splits:new index_1.Splits(e)}};var u=function(e){return s.summonBucketableSplit(e,a,i)};if(t.length()===1&&l){return o([u(l)])}else if(t.isBucketedFollowedByUnbucketed()){var m=t.get(0);var f=t.get(1);var c=this.ensureSplitOrder(t,m,f,e),p=c.primarySplit,d=c.colorSplit;return o([d,u(p)])}else if(t.length()===2&&l){var d=t.splitCombines.filter(function(e){return!e.equals(l)})[0];return o([d,u(l)])}return null};t.prototype.canHandleSplitDimensions=function(e,t,i,n){var r=e.getSplitableDimensions().filter(function(e){return e.isBucketable()});var s=function(e){return index_1.SplitCombine.fromDimensionAndFilterAndMeasure(e,i,n)};if(!t.some(function(e){return e.isBucketable()})){return manifest_1.Resolve.rejectDimensions("The Line chart requires at least one bucketed split",r.map(function(e){return manifest_1.SplitSuggestion.fromTitleAndSplit("Add a split on "+e.title,s(e))}))}else if(!t.length){return manifest_1.Resolve.rejectDimensions("The Line Chart requires at least one bucketed split",r.map(function(e){return manifest_1.SplitSuggestion.fromTitleAndSplit("Add a split on "+e.title,s(e))}))}else if(t.length>2&&r.length){return manifest_1.Resolve.rejectDimensions("Too many splits on the line chart",[manifest_1.SplitSuggestion.fromTitleAndSplit("Remove all but the first bucketed split",s(t[0]))])}else{return manifest_1.Resolve.proceedWithDimensions()}};t.prototype.getSuitability=function(e,t,i,n){var r=e.getSplitableDimensions();var s=function(e){return immutable_class_1.NamedArray.findByName(r,e.dimension)};var a=false;var l=t.splitCombines.some(function(e){return s(e).getKind()==="time"})?9:5;var o=null;if(t.length()===1){o=t.first();if(i)a=true}else{var u=t.first();o=t.get(1);if(!i||i.dimension!==u.dimension||!u.limitAction){a=true}}if(n)l=10;if(o.limitAction){var m=manifest_1.Resolve.rejectCombines("The line chart cannot handle a limit",[immutable_class_1.NamedArray.findByName(index_2.MANIFESTS,"table"),immutable_class_1.NamedArray.findByName(index_2.MANIFESTS,"bar-chart")]);return new manifest_1.Suitability(0,m)}if(!o.isSortOnSelfAscending()){var m=manifest_1.Resolve.rejectCombines("The line chart cannot handle this sort",[immutable_class_1.NamedArray.findByName(index_2.MANIFESTS,"table")]);return new manifest_1.Suitability(0,m)}if(!o.isBucketed()){var m=manifest_1.Resolve.rejectCombines("The line chart must have a bucketed second split",[immutable_class_1.NamedArray.findByName(index_2.MANIFESTS,"table")]);return new manifest_1.Suitability(0,m)}return new manifest_1.Suitability(a?l-1:l)};t.prototype.getEffectiveSplits=function(e){if(e.length()===2){var t=e.first();if(!t.limitAction){e=e.replace(t,t.changeLimit(5))}}return e};t.prototype.getEffectiveColors=function(e,t,i){if(t.length()===0||t.length()===1){i=null}else{var n=t.first();var r=n.dimension;if(!i||i.dimension!==r){i=index_1.Colors.fromLimit(r,5)}}return i};return t}(manifest_1.Manifest);exports.LineChartManifest=LineChartManifest;exports.LINE_CHART_MANIFEST=new LineChartManifest;