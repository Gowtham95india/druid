"use strict";var __extends=this&&this.__extends||function(e,t){for(var s in t)if(t.hasOwnProperty(s))e[s]=t[s];function a(){this.constructor=e}e.prototype=t===null?Object.create(t):(a.prototype=t.prototype,new a)};var immutable_class_1=require("immutable-class");var Q=require("q");var strings_1=require("../../utils/constants/strings");var hash_1=require("../../utils/hash/hash");var User=function(e){__extends(t,e);function t(){e.apply(this,arguments)}t.isUser=function(e){return e instanceof t};t.modeNeedsUserButton=function(e){return e==="native-users"||e==="external-users"||e==="external-users-and-session"};t.modeNeedsUserTable=function(e){return e==="native-users"};t.fromJS=function(e){var s=e.id;if(s&&!e.name){e.name=s}return new t(immutable_class_1.BaseImmutable.jsToValue(t.PROPERTIES,e))};t.fromName=function(e){return new t({name:e})};t.getValidUser=function(e,t,s,a){var n=immutable_class_1.NamedArray.findByName(e,t);if(n)return n.passEquals(s,a).then(function(e){return e?n:null});return Q(null)};t.prototype.canAccessSettings=function(){return this.getPermissionType()==="admin"};t.prototype.updatePass=function(e){var t=this;var s=this.getHashStrategy();if(s==="sha2"){return Q(this.changePass(hash_1.saltedSha2(e)))}else if(s==="bcrypt"){return hash_1.bcryptHash(e).then(function(e){return t.changePass(e)})}else{return Q(this.changePass(e))}};t.prototype.getStatus=function(){var e=this.status;if(e===t.STATUS_OK)return strings_1.STRINGS.ok;if(e===t.STATUS_PASSWORD_RESET)return strings_1.STRINGS.passwordReset;return strings_1.STRINGS.invitationLink};t.prototype.getDisplayName=function(){var e=this,t=e.firstName,s=e.lastName;if(t&&s)return t+" "+s;return t||s||"???"};t.prototype.equalsByName=function(e){if(!e)return false;return this.name===e.name};t.prototype.passEquals=function(e,t){if(!e)return Q(false);var s=this.getHashStrategy();var a=this.pass;switch(s){case"none":return Q(this.pass===e);case"sha2":return Q(t?hash_1.sha2(t+e)===a:hash_1.saltedSha2(e)===a);case"bcrypt":return hash_1.bcryptCompare(e,a)}};t.prototype.toClientUser=function(){var e=this.valueOf();delete e.pass;delete e.hashStrategy;return new t(e)};t.PERMISSION_TYPES=["user","admin"];t.STATUS_PASSWORD_RESET="passwordReset";t.STATUS_INVITATION_LINK="invitationLink";t.STATUS_OK="ok";t.STATUSES=[t.STATUS_INVITATION_LINK,t.STATUS_OK,t.STATUS_PASSWORD_RESET];t.PROPERTIES=[{name:"name"},{name:"email",defaultValue:null},{name:"firstName",defaultValue:null},{name:"lastName",defaultValue:null},{name:"pass",defaultValue:null,equal:function(e,t){return true}},{name:"permissionType",possibleValues:t.PERMISSION_TYPES,defaultValue:"user"},{name:"status",defaultValue:t.STATUS_OK,possibleValues:t.STATUSES},{name:"hashStrategy",defaultValue:"bcrypt",possibleValues:["none","sha2","bcrypt"]}];return t}(immutable_class_1.BaseImmutable);exports.User=User;immutable_class_1.BaseImmutable.finalize(User);User.DEFAULT_ADMIN=new User({name:"admin@admin.com",email:"admin@admin.com",pass:"password",hashStrategy:"none",firstName:"Default",lastName:"Admin",permissionType:"admin"});