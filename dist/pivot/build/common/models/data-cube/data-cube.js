"use strict";var __extends=this&&this.__extends||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)};var immutable_class_1=require("immutable-class");var chronoshift_1=require("chronoshift");var plywood_1=require("plywood");var general_1=require("../../utils/general/general");var string_1=require("../../utils/string/string");var time_1=require("../../utils/time/time");var dimension_1=require("../dimension/dimension");var measure_1=require("../measure/measure");var filter_clause_1=require("../filter-clause/filter-clause");var filter_1=require("../filter/filter");var splits_1=require("../splits/splits");var refresh_rule_1=require("../refresh-rule/refresh-rule");var MAX_TIME="maxTime";function formatTimeDiff(e){e=Math.round(Math.abs(e)/1e3);if(e<60)return"less than 1 minute";e=Math.floor(e/60);if(e===1)return"1 minute";if(e<60)return e+" minutes";e=Math.floor(e/60);if(e===1)return"1 hour";if(e<=24)return e+" hours";e=Math.floor(e/24);return e+" days"}function checkUnique(e,t,r){var i={};var n={};if(e){e.forEach(function(e){var t=e.name.toLowerCase();if(i[t]){throw new Error("duplicate dimension name '"+e.name+"' found in data cube: '"+r+"'")}i[t]=e})}if(t){t.forEach(function(e){var t=e.name.toLowerCase();if(n[t]){throw new Error("duplicate measure name '"+e.name+"' found in data cube: '"+r+"'")}if(i[t]&&!i[t].unsplitable){throw new Error("name '"+e.name+"' found in both dimensions and measures in data cube: '"+r+"'")}n[t]=e})}}function measuresFromLongForm(e){var t=e.metricColumn,r=e.measures,i=e.possibleAggregates;var n={};for(var a in i){if(!general_1.hasOwnProperty(i,a))continue;n[a]=plywood_1.Expression.fromJSLoose(i[a])}return r.map(function(e){if(general_1.hasOwnProperty(e,"name")){return measure_1.Measure.fromJS(e)}var r=e.title;if(!r){throw new Error("must have title in longForm value")}var i=e.value;var a=e.aggregate;if(!a){throw new Error("must have aggregates in longForm value")}var s=n[a];if(!s)throw new Error("can not find aggregate "+a+" for value "+i);var o=general_1.makeUrlSafeName(a+"_"+i);return new measure_1.Measure({name:o,title:r,units:e.units,formula:s.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name==="filtered"){return plywood_1.$("main").filter(plywood_1.$(t).is(plywood_1.r(i)))}return null}).toString()})})}function filterFromLongForm(e){var t=e.metricColumn,r=e.measures;var i=[];for(var n=0,a=r;n<a.length;n++){var s=a[n];if(general_1.hasOwnProperty(s,"aggregate"))i.push(s.value)}return plywood_1.$(t).in(i).simplify()}function attributesToJS(e){return plywood_1.AttributeInfo.toJSs(e)}var DataCube=function(e){__extends(t,e);function t(t){e.call(this,t);var r=this,i=r.name,n=r.dimensions,a=r.measures;if(typeof i!=="string")throw new Error("DataCube must have a name");if(!this.source)this.source=i;this.subsetExpression=t.subsetFormula?plywood_1.Expression.fromJSLoose(t.subsetFormula):plywood_1.Expression.TRUE;var s=immutable_class_1.NamedArray.findByName(n,this.specialTimeDimension);if(s&&s.type&&s.type!=="TIME"){throw new Error(this.specialTimeDimension+" is set as the special time attribute but is of type "+s.type)}if(n.length&&!this.specialTimeDimension){var o=n.filter(function(e){return e.type==="TIME"});if(o.length>0){this.specialTimeDimension=o[0].name}}checkUnique(n,a,i);this._validateDefaults()}t.isDataCube=function(e){return e instanceof t};t.processMaxTimeQuery=function(e){var t=new Date(e.data[0][MAX_TIME]);if(isNaN(t))return null;return t};t.suggestDimensions=function(e){var t=e.map(function(e){var t=e.name,r=e.type,i=e.special,n=e.unsplitable;if(!r)throw new Error("attribute has no type");return new dimension_1.Dimension({name:general_1.makeUrlSafeName(t),type:r,special:i,unsplitable:n})});return t};t.suggestMeasures=function(e){var t=[];var r=function(e){var r=e.name,i=e.type,n=e.special;switch(i){case"STRING":if(n==="unique"||n==="theta"){t=t.concat(measure_1.Measure.measuresFromDimension(e))}break;case"NUMBER":var a=measure_1.Measure.measuresFromDimension(e);a.forEach(function(e){if(r==="count"||r==="sum_count"){t.unshift(e)}else{t.push(e)}});break}};for(var i=0,n=e;i<n.length;i++){var a=n[i];r(a)}return t};t.fromClusterAndSource=function(e,r,i){return t.fromJS({name:e,title:general_1.makeTitle(i),clusterName:r.name,source:i})};t.fromJS=function(e){var r=e.clusterName||e.engine;var i=e.introspection;var n=e.defaultSplits;var a=e.specialTimeDimension||e.specialTimeAttribute||e.realTimeAttribute||e.primaryTimeAttribute;var s=e.options;if(s){if(s.skipIntrospection){if(!i)i="none";delete s.skipIntrospection}if(s.disableAutofill){if(!i)i="no-autofill";delete s.disableAutofill}if(s.defaultSplitDimension){s.defaultSplits=s.defaultSplitDimension;delete s.defaultSplitDimension}if(s.defaultSplits){if(!n)n=s.defaultSplits;delete s.defaultSplits}}if(!a&&e.timeAttribute&&e.timeAttribute!=="__time"){a=e.timeAttribute;if(!s)s={};s.druidTimeAttributeName=a}var o=e.dimensions||[];var u=e.measures||[];var l=e.derivedAttributes;if(l){for(var m in l){var f=immutable_class_1.NamedArray.findByName(o,m);if(f){if(!f.formula){f.formula=plywood_1.Expression.fromJSLoose(l[m]).toString()}}else{var p={name:m,formula:plywood_1.Expression.fromJSLoose(l[m]).toString()};if(immutable_class_1.NamedArray.findByName(u,m))p.unsplitable=true;o.push(p)}}}var c=e.attributes||e.attributeOverrides||(e.options||{}).attributeOverrides;if(c){for(var d=0,h=c;d<h.length;d++){var y=h[d];var f=immutable_class_1.NamedArray.findByName(o,y.name);if(f){Object.assign(f,y)}else{if(immutable_class_1.NamedArray.findByName(u,y.name))y.unsplitable=true;o.push(y)}}if((e.options||{}).attributeOverrides){delete e.options["attributeOverrides"]}}if(i&&t.INTROSPECTION_VALUES.indexOf(i)===-1){throw new Error("invalid introspection value "+i+", must be one of "+t.INTROSPECTION_VALUES.join(", "))}var g=e.refreshRule?refresh_rule_1.RefreshRule.fromJS(e.refreshRule):null;var _=o.map(function(e){return dimension_1.Dimension.fromJS(e)});var v=u.map(function(e){return measure_1.Measure.fromJS(e)});var T=e.subsetFormula||e.subsetFilter;var D=e.longForm;if(D){v=v.concat(measuresFromLongForm(D));if(D.addSubsetFilter){var E=T?plywood_1.Expression.fromJSLoose(e.subsetFormula):plywood_1.Expression.TRUE;T=JSON.stringify(E.and(filterFromLongForm(D)).simplify())}}var b={dimensions:_,measure:e.defaultSortMeasure||(v&&v.length?v[0].name:null)};var S={name:e.name,title:e.title,description:e.description,clusterName:r,source:e.source,group:e.group,subsetFormula:T,rollup:e.rollup,options:s,introspection:i,dimensions:_,measures:v,specialTimeDimension:a,defaultTimezone:e.defaultTimezone?chronoshift_1.Timezone.fromJS(e.defaultTimezone):null,defaultFilter:e.defaultFilter?filter_1.Filter.fromJS(e.defaultFilter):null,defaultSplits:n?splits_1.Splits.fromJS(n,b):null,defaultDuration:e.defaultDuration?chronoshift_1.Duration.fromJS(e.defaultDuration):null,defaultSortMeasure:e.defaultSortMeasure,defaultSelectedMeasures:e.defaultSelectedMeasures,defaultPinnedDimensions:e.defaultPinnedDimensions,refreshRule:g};return new t(S)};t.prototype._validateDefaults=function(){var e=this,t=e.measures,r=e.defaultSortMeasure;if(r){if(!immutable_class_1.NamedArray.findByName(t,r)){throw new Error("can not find defaultSortMeasure '"+r+"' in data cube '"+this.name+"'")}}};t.prototype.toExternal=function(e,t){if(this.clusterName==="native")throw new Error("there is no external on a native data cube");var r=this.options;if(!r)r={};var i=this.getAttributesAndDerivedAttributes();var n={engine:e.type,suppress:true,source:this.source,version:e.version,customAggregations:r.customAggregations,customTransforms:r.customTransforms,attributes:i.attributes,derivedAttributes:i.derivedAttributes,filter:this.subsetExpression};if(t){n.requester=t}if(e.type==="druid"){n.rollup=this.rollup;n.introspectionStrategy=e.getIntrospectionStrategy();n.allowSelectQueries=true;n.allowEternity=!this.getSpecialTimeDimension();if(r.druidTimeAttributeName){n.timeAttribute=r.druidTimeAttributeName}var a=r.druidContext||{};a["timeout"]=e.getTimeout();if(r.priority)a["priority"]=r.priority;n.context=a}return plywood_1.External.fromValue(n)};t.prototype.incomplete=function(){var e=this.getMeasureTypeContext();return this.measures.some(function(t){try{t.expression.changeInTypeContext(e);return false}catch(e){return true}})};t.prototype.getMainTypeContext=function(){var e=this.dimensions;if(!e)return null;var t={};for(var r=0,i=e;r<i.length;r++){var n=i[r];t[n.name]={type:n.type}}return{type:"DATASET",datasetType:t}};t.prototype.getMeasureTypeContext=function(){return{type:"DATASET",datasetType:{main:this.getMainTypeContext()}}};t.prototype.validateFilterFormula=function(e){var t=plywood_1.Expression.parse(e);if(t instanceof plywood_1.LiteralExpression){if(t.type==="BOOLEAN")return true;throw new Error("can not be a constant")}var r=this.getMainTypeContext();try{t.changeInTypeContext(r)}catch(e){throw new Error("Invalid formula: "+e.message)}return true};t.prototype.validateMeasureFormula=function(e){var t=plywood_1.Expression.parse(e);if(t.getFreeReferences().indexOf("main")===-1){throw new Error("Measure formula must contain a $main reference.")}return true};t.prototype.toClientDataCube=function(){var e=this.valueOf();e.subsetFormula=null;e.introspection=null;e.options=null;return new t(e)};t.prototype.getClusterType=function(e){var t=this.clusterName;if(t==="native")return"native";var r=immutable_class_1.NamedArray.findByName(e,t);if(!r)throw new Error("can not find cluster '"+t+"'");return r.type};t.prototype.getMaxTimeQuery=function(){var e=this.getSpecialTimeExpression();if(!e)return null;return plywood_1.ply().apply(MAX_TIME,plywood_1.$("main").max(e))};t.prototype.getMaxTime=function(e){var t=this.name;var r=this.getRefreshRule();if(r.isRealtime()){return e.now()}else if(r.isFixed()){return r.time}else{return e.getTime(t)}};t.prototype.updatedText=function(e,t){var r=this.getRefreshRule();if(r.isRealtime()){return"Updated ~1 second ago"}else if(r.isFixed()){return"Fixed to "+time_1.getWallTimeString(r.time,t,true)}else{var i=this.getMaxTime(e);if(i){return"Updated "+formatTimeDiff(e.now().valueOf()-i.valueOf().valueOf())+" ago"}else{return null}}};t.prototype.getDimensions=function(){return this.dimensions};t.prototype.getDimension=function(e){return dimension_1.Dimension.getDimension(this.getDimensions(),e)};t.prototype.getSplitableDimensions=function(){return this.dimensions.filter(function(e){return!e.unsplitable})};t.prototype.getSplitableDimension=function(e){return dimension_1.Dimension.getDimension(this.getSplitableDimensions(),e)};t.prototype.getSplitableDimensionByKind=function(e){return this.getSplitableDimensions().filter(function(t){return t.kind===e})};t.prototype.getSuggestedDimensions=function(e){return this.filterDimensions(t.suggestDimensions(e))};t.prototype.getSpecialTimeDimension=function(){var e=this.specialTimeDimension;if(e===t.NO_SPECIAL_TIME_ATTRIBUTE)return null;if(!immutable_class_1.NamedArray.findByName(this.getDimensions(),e))return null;return e||null};t.prototype.isSpecialTimeDimension=function(e){var t=this.getSpecialTimeDimension();if(!e||!t)return false;return t===e.name};t.prototype.getSpecialTimeExpression=function(){var e=this.getSpecialTimeDimension();return e?plywood_1.$(e):null};t.prototype.isSpecialTimeExpression=function(e){var t=this.getSpecialTimeExpression();if(!t)return false;return t.equals(e)};t.prototype.isMandatoryFilter=function(e){var t=this.specialTimeDimension;return t&&t===e};t.prototype.getMeasures=function(){if(this.measures.length)return this.measures;return[measure_1.Measure.SIMPLE_COUNT]};t.prototype.getMeasure=function(e){return measure_1.Measure.getMeasure(this.getMeasures(),e)};t.prototype.getMeasureByExpression=function(e){return immutable_class_1.SimpleArray.find(this.getMeasures(),function(t){return t.expression.equals(e)})};t.prototype.getDimensionForDimension=function(e){return this.getDimensions().filter(function(t){return t.usesDimension(e)})};t.prototype.getMeasuresForDimension=function(e){return this.getMeasures().filter(function(t){return t.usesDimension(e)})};t.prototype.getSuggestedMeasures=function(){return this.filterMeasures(t.suggestMeasures(this.dimensions))};t.prototype.filterMeasures=function(e){var t=this;return e.filter(function(e){if(immutable_class_1.NamedArray.findByName(t.measures,e.name))return false;if(immutable_class_1.NamedArray.findByName(t.dimensions,e.name))return false;var r=e.expression;if(immutable_class_1.SimpleArray.find(t.measures,function(e){return e.expression.equals(r)}))return false;return true})};t.prototype.removeDimension=function(e){var r=this.valueOf();r.dimensions=immutable_class_1.NamedArray.deleteByName(r.dimensions,e);r.measures=r.measures.filter(function(t){return!t.usesDimension(e)});return new t(r)};t.prototype.removeMeasure=function(e){var t=this.measures.indexOf(e);if(t===-1){throw new Error("Unknown measure : "+e.toString())}var r=immutable_class_1.SimpleArray.deleteIndex(this.measures,t);return this.changeMeasures(r)};t.prototype.filterDimensions=function(e){var t=this;return e.filter(function(e){if(t.getDimension(e.name))return false;if(t.getMeasure(e.name))return false;return true})};t.prototype.rolledUp=function(){return this.clusterName==="druid"};t.prototype.getAttributesAndDerivedAttributes=function(){var e=this.dimensions.filter(function(e){return!e.isDerived()}).map(function(e){return e.toAttribute()});var t={};this.dimensions.forEach(function(r){if(r.isDerived()){var i=r.toDerivedExpression();t[r.name]=i;i.forEach(function(t){if(t instanceof plywood_1.RefExpression){var r=t.name;if(!immutable_class_1.NamedArray.findByName(e,r)){var i=plywood_1.AttributeInfo.fromJS({name:r,type:t.type||"STRING"});e.push(i)}}})}});this.measures.forEach(function(t){t.expression.forEach(function(t){if(t instanceof plywood_1.RefExpression){var r=t.name;if(r!=="main"&&!immutable_class_1.NamedArray.findByName(e,r)){var i=plywood_1.AttributeInfo.fromJS({name:r,type:t.type||"NUMBER",unsplitable:true});e.push(i)}}})});return{attributes:e,derivedAttributes:t}};t.prototype.changeDimension=function(e){return this.changeDimensions(immutable_class_1.NamedArray.overrideByName(this.dimensions,e))};t.prototype.fillAllFromAttributes=function(e){var t=this.dimensions.length===0&&this.measures.length===0;var r=this.appendDimensions(this.getSuggestedDimensions(e));var i=r.getSuggestedMeasures();if(t&&!i.length){i=[new measure_1.Measure({name:"count",title:"Count",formula:"$main.count()"})]}r=r.appendMeasures(i);return r};t.prototype.getIntrospection=function(){return this.introspection||t.DEFAULT_INTROSPECTION};t.prototype.getDefaultFilter=function(){var e=this.defaultFilter||t.DEFAULT_DEFAULT_FILTER;var r=this.getSpecialTimeDimension();if(r){e=e.setSelection(r,plywood_1.$(filter_clause_1.FilterClause.MAX_TIME_REF_NAME).timeRange(this.getDefaultDuration(),-1))}return e};t.prototype.getDefaultSortMeasure=function(){if(this.defaultSortMeasure){return this.defaultSortMeasure}return this.getMeasures()[0].name};t.prototype.getDefaultSelectedMeasures=function(){var e=this.defaultSelectedMeasures;return e.length?e:this.measures.slice(0,4).map(function(e){return e.name})};t.prototype.changeDefaultSortMeasure=function(e){return this.change("defaultSortMeasure",e)};t.prototype.appendMeasures=function(e){return this.changeMeasures(this.measures.concat(e))};t.prototype.appendDimensions=function(e){return this.changeDimensions(this.dimensions.concat(e))};t.prototype.sameGroup=function(e){return Boolean(this.group&&this.group===e.group)};t.prototype.guessTitle=function(){if(!this.source)return this.title;var e=this.source.split(/[\/\\]/);var t=e[e.length-1];return general_1.makeTitle(t)};t.prototype.guessName=function(){if(!this.source)return this.name;var e=this.source.split(/[\/\\]/);var t=e[e.length-1];return general_1.makeUrlSafeName(t)};t.prototype.getLatitudeLongitudeDimensions=function(){var e=this.getDimension(t.LATITUDE_NAME);var r=this.getDimension(t.LONGITUDE_NAME);return e&&r?{latitude:e,longitude:r}:null};t.prototype.straightenDimensionName=function(e){var t=this;e=e.changeName(string_1.generateUniqueName(e.guessName(),function(e){return!t.getDimension(e)},{suffixIfAlreadyUnique:false,separator:"-",startAt:1}));if(e.title==="New dimension")e=e.changeTitle(e.guessTitle());return e};t.prototype.straightenMeasureName=function(e){var t=this;e=e.changeName(string_1.generateUniqueName(e.guessName(),function(e){return!t.getMeasure(e)},{suffixIfAlreadyUnique:false,separator:"-",startAt:1}));if(e.title==="New measure")e=e.changeTitle(e.guessTitle());return e};t.DEFAULT_INTROSPECTION="autofill-all";t.INTROSPECTION_VALUES=["none","no-autofill","autofill-dimensions-only","autofill-measures-only","autofill-all"];t.DEFAULT_DEFAULT_TIMEZONE=chronoshift_1.Timezone.UTC;t.DEFAULT_DEFAULT_FILTER=filter_1.Filter.EMPTY;t.DEFAULT_DEFAULT_SPLITS=splits_1.Splits.EMPTY;t.DEFAULT_DEFAULT_DURATION=chronoshift_1.Duration.fromJS("P1D");t.NO_SPECIAL_TIME_ATTRIBUTE="!NONE";t.LATITUDE_NAME="lat";t.LONGITUDE_NAME="lon";t.PROPERTIES=[{name:"name",validate:general_1.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"description",defaultValue:""},{name:"clusterName",defaultValue:null},{name:"source",defaultValue:null},{name:"group",defaultValue:null},{name:"subsetFormula",defaultValue:null},{name:"rollup",defaultValue:false},{name:"complete",defaultValue:false},{name:"options",defaultValue:{},equal:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{name:"introspection",defaultValue:t.DEFAULT_INTROSPECTION},{name:"dimensions",immutableClassArray:dimension_1.Dimension,type:immutable_class_1.PropertyType.ARRAY},{name:"measures",immutableClassArray:measure_1.Measure,type:immutable_class_1.PropertyType.ARRAY},{name:"specialTimeDimension",defaultValue:null},{name:"defaultTimezone",immutableClass:chronoshift_1.Timezone,defaultValue:t.DEFAULT_DEFAULT_TIMEZONE},{name:"defaultFilter",immutableClass:filter_1.Filter,defaultValue:t.DEFAULT_DEFAULT_FILTER},{name:"defaultSplits",immutableClass:splits_1.Splits,defaultValue:t.DEFAULT_DEFAULT_SPLITS},{name:"defaultDuration",immutableClass:chronoshift_1.Duration,defaultValue:t.DEFAULT_DEFAULT_DURATION},{name:"defaultSortMeasure",defaultValue:null},{name:"defaultSelectedMeasures",type:immutable_class_1.PropertyType.ARRAY},{name:"defaultPinnedDimensions",type:immutable_class_1.PropertyType.ARRAY},{name:"refreshRule",immutableClass:refresh_rule_1.RefreshRule,defaultValue:refresh_rule_1.RefreshRule.query()}];return t}(immutable_class_1.BaseImmutable);exports.DataCube=DataCube;immutable_class_1.BaseImmutable.finalize(DataCube);