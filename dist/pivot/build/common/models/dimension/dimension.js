"use strict";var __extends=this&&this.__extends||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)};var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var Icons=require("@implydata/little-pictures");var general_1=require("../../utils/general/general");var granularity_1=require("../granularity/granularity");var GEO_CODES=require("./geo-codes/index");function typeToKind(e){if(!e)return e;return e.toLowerCase().replace(/_|\//g,"-").replace(/-range$/,"").replace("set-","")}function kindToType(e){if(!e)return e;return e.toUpperCase().replace("SET-","").replace("-GEO","")}var Dimension=function(e){__extends(t,e);function t(t){e.call(this,t);var r=this.name;this.title=t.title||general_1.makeTitle(r);this.expression=this.formula?plywood_1.Expression.parse(this.formula):plywood_1.$(r);this.kind=typeToKind(this.type);if(this.special){this.unsplitable=true}if(this.geo&&!this.geoEncoding){this.geoEncoding=GEO_CODES.ENCODINGS[0]}if(this.url&&typeof t.url!=="string"){throw new Error("unsupported url: "+t.url+": only strings are supported")}var n=t.granularities;if(n){if(!Array.isArray(n)||n.length!==5){throw new Error("must have list of 5 granularities in dimension '"+t.name+"'")}var i=null;this.granularities=n.map(function(e){if(i===null)i=e.op;if(e.op!==i)throw new Error("granularities must have the same type of actions");return e})}}t.isDimension=function(e){return e instanceof t};t.getDimension=function(e,t){if(!t)return null;return immutable_class_1.NamedArray.findByNameCI(e,t)};t.typeToKind=function(e){if(!e)return e;return e.toLowerCase().replace(/_|\//g,"-").replace(/-range$/,"")};t.fromJS=function(e){var r={name:e.name,title:e.title,formula:e.formula||e.expression,type:e.type||kindToType(e.kind),special:e.special,unsplitable:e.unsplitable,url:e.url};if(!r.type){r.type=(r.formula?plywood_1.Expression.fromJSLoose(r.formula).type:null)||"STRING"}var n=e.maker;if(n){r.maker=plywood_1.Expression.fromJSLoose(n)}var i=e.granularities;if(i){r.granularities=i.map(granularity_1.granularityFromJS)}var a=e.bucketedBy;if(a){r.bucketedBy=granularity_1.granularityFromJS(a)}var u=e.bucketingStrategy;if(u){r.bucketingStrategy=u}var o=e.sortStrategy;if(o){r.sortStrategy=o}if(e.geo){r.geo=true;if(GEO_CODES.ENCODINGS.indexOf(e.geoEncoding)>-1){r.geoEncoding=e.geoEncoding}}return new t(r)};t.prototype.toJS=function(){var t=e.prototype.toJS.call(this);if(this.granularities)t.granularities=this.granularities.map(function(e){return granularity_1.granularityToJS(e)});if(this.bucketedBy)t.bucketedBy=granularity_1.granularityToJS(this.bucketedBy);return t};t.prototype.canAutoBucket=function(){var e=this.getBucketingStrategy();return this.isContinuous()&&e!==t.DEFAULT_NO_BUCKET&&e!==t.NEVER_BUCKET};t.prototype.isBucketable=function(){return this.isContinuous()&&this.getBucketingStrategy()!==t.NEVER_BUCKET};t.prototype.getBucketingStrategy=function(){var e=this,r=e.bucketingStrategy,n=e.kind;if(!r&&n==="time")return t.ALWAYS_BUCKET;return r};t.prototype.canHaveNoBucket=function(){return this.getBucketingStrategy()!==t.ALWAYS_BUCKET};t.prototype.isContinuous=function(){var e=this.type;return e==="TIME"||e==="NUMBER"};t.prototype.toAttribute=function(){var e={name:this.name,type:this.type,unsplitable:this.getUnsplitable()};if(this.special)e.special=this.special;return plywood_1.AttributeInfo.fromJS(e)};t.prototype.toDerivedExpression=function(){return this.expression.cast(this.type)};t.prototype.getComboType=function(){var e=this,t=e.special,r=e.type,n=e.geo;if(t)return t.replace(/^\w/,function(e){return e.toUpperCase()});if(n)return"Geo";return r.toLowerCase().replace(/^\w|\/\w/g,function(e){return e.toUpperCase()})};t.prototype.changeComboType=function(e){var r=this.valueOf();r.geo=false;r.special=null;switch(e){case"Boolean":case"String":case"Set/String":case"Number":case"Time":r.type=e.toUpperCase();break;case"Geo":r.type="STRING";r.geo=true;break;case"Unique":r.type="STRING";r.special="unique";break;case"Theta":r.type="STRING";r.special="theta";break;case"Histogram":r.type="NUMBER";r.special="histogram";break}return new t(r)};t.prototype.getFormula=function(){return this.formula||this.expression.toString()};t.prototype.getColumn=function(){if(this.expression instanceof plywood_1.RefExpression){return this.expression.name}return null};t.prototype.changeColumn=function(e){return this.changeFormula(plywood_1.$(e).toString())};t.prototype.getKind=function(){return this.kind};t.prototype.getUnsplitable=function(){if(this.special)return true;return this.unsplitable||false};t.prototype.changeUnsplitable=function(e){if(this.special)e=true;var r=this.valueOf();r.unsplitable=e;return new t(r)};t.prototype.getGranularities=function(){if(!this.isContinuous())return null;return this.granularities||granularity_1.getGranularities(this.kind,this.bucketedBy,false,this.canHaveNoBucket())};t.prototype.isGeo=function(){return this.geo};t.prototype.isDerived=function(){return!this.expression.equals(plywood_1.$(this.name))};t.prototype.getCoordinatesConverter=function(){if(!this.isGeo())return null;var e=GEO_CODES.getCodes(this.geoEncoding);return function(t){return e[t]}};t.prototype.usesDimension=function(e){return this.expression.some(function(t){if(t instanceof plywood_1.RefExpression){return t.name===e}else{return null}})};t.prototype.fromColumn=function(){if(this.expression instanceof plywood_1.RefExpression){return this.expression.name}return null};t.prototype.isTime=function(){return this.kind==="time"};t.prototype.isBoolean=function(){return this.kind==="boolean"};t.prototype.guessName=function(){return general_1.makeNameFromFormula(this.formula)};t.prototype.guessTitle=function(){return general_1.makeTitle(this.name)};t.prototype.getIcon=function(){if(this.isGeo())return Icons.DIM_GEO;if(this.isTime())return Icons.DIM_TIME;if(this.isContinuous())return Icons.DIM_NUMBER;if(this.isBoolean())return Icons.DIM_BOOLEAN;return Icons.DIM_STRING};t.GEO_ENCODINGS=GEO_CODES.ENCODINGS;t.ALWAYS_BUCKET="alwaysBucket";t.DEFAULT_BUCKET="defaultBucket";t.DEFAULT_NO_BUCKET="defaultNoBucket";t.NEVER_BUCKET="neverBucket";t.COMBO_TYPES_NORMAL=[{label:"Boolean",value:"Boolean"},{label:"String",value:"String"},{label:"Set/String",value:"Set/String"},{label:"Number",value:"Number"},{label:"Time",value:"Time"},{label:"Geo",value:"Geo"}];t.COMBO_TYPES_UNSPLITABLE=[{label:"String",value:"String"},{label:"Number",value:"Number"},{label:"Unique",value:"Unique"},{label:"Theta",value:"Theta"},{label:"Histogram",value:"Histogram"}];t.BUCKETING_STRATEGIES=[{label:"Always bucket",value:t.ALWAYS_BUCKET},{label:"Default bucket",value:t.DEFAULT_BUCKET},{label:"Default donâ€™t bucket",value:t.DEFAULT_NO_BUCKET},{label:"Never bucket",value:t.NEVER_BUCKET}];t.PROPERTIES=[{name:"name",validate:general_1.verifyUrlSafeName},{name:"title",defaultValue:null},{name:"formula",defaultValue:null},{name:"type"},{name:"special",defaultValue:null},{name:"unsplitable",defaultValue:false},{name:"maker",defaultValue:null,immutableClass:plywood_1.Expression},{name:"url",defaultValue:null},{name:"granularities",defaultValue:[],equal:immutable_class_1.immutableArraysEqual},{name:"bucketedBy",defaultValue:null,equal:granularity_1.granularityEquals},{name:"bucketingStrategy",defaultValue:null,possibleValues:["defaultBucket","defaultNoBucket","neverBucket","alwaysBucket"]},{name:"sortStrategy",defaultValue:null},{name:"geo",defaultValue:false},{name:"geoEncoding",defaultValue:null,possibleValues:GEO_CODES.ENCODINGS}];return t}(immutable_class_1.BaseImmutable);exports.Dimension=Dimension;immutable_class_1.BaseImmutable.finalize(Dimension);