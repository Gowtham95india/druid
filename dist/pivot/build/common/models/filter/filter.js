"use strict";var immutable_class_1=require("immutable-class");var plywood_1=require("plywood");var filter_clause_1=require("../filter-clause/filter-clause");function withholdClause(e,t,r){return e.filter(function(e,n){return n===r||!e.equals(t)})}function swapClause(e,t,r,n){return e.map(function(e,i){return i===n||!e.equals(t)?e:r})}function dateToFileString(e){return e.toISOString().replace("T","_").replace("Z","").replace(".000","")}var check;var Filter=function(){function e(e){this.clauses=e}e.isFilter=function(t){return t instanceof e};e.fromClause=function(t){if(!t)throw new Error("must have clause");return new e([t])};e.fromJS=function(t){var r=plywood_1.Expression.fromJSLoose(t);var n=null;if(r.equals(plywood_1.Expression.TRUE)){n=[]}else if(r instanceof plywood_1.AndExpression){n=r.getExpressionList().map(function(e){return filter_clause_1.FilterClause.fromExpression(e)})}else{n=[filter_clause_1.FilterClause.fromExpression(r)]}return new e(n)};e.prototype.valueOf=function(){return this.clauses};e.prototype.toJS=function(){return this.toExpression().toJS()};e.prototype.toJSON=function(){return this.toJS()};e.prototype.toString=function(){return this.clauses.map(function(e){return e.toString()}).join(" and ")};e.prototype.equals=function(t){return e.isFilter(t)&&immutable_class_1.immutableArraysEqual(this.clauses,t.clauses)};e.prototype.replaceByIndex=function(t,r){var n=this.clauses;if(n.length===t)return this.insertByIndex(t,r);var i=n[t];n=n.map(function(e,n){return n===t?r:e});n=swapClause(n,r,i,t);return new e(n)};e.prototype.insertByIndex=function(t,r){var n=this.clauses;n=immutable_class_1.SimpleArray.insertIndex(n,t,r);n=withholdClause(n,r,t);return new e(n)};e.prototype.isEmpty=function(){return this.clauses.length===0};e.prototype.single=function(){return this.clauses.length===1};e.prototype.length=function(){return this.clauses.length};e.prototype.toExpression=function(){var e=this.clauses.map(function(e){return e.toExpression()});switch(e.length){case 0:return plywood_1.Expression.TRUE;case 1:return e[0];default:return plywood_1.Expression.and(e)}};e.prototype.isRelative=function(){return this.clauses.some(function(e){return e.relative})};e.prototype.getSpecificFilter=function(t,r,n){if(!this.isRelative())return this;return new e(this.clauses.map(function(e){return e.evaluate(t,r,n)}))};e.prototype.indexOfClause=function(e){return this.clauses.findIndex(function(t){return t.dimension===e})};e.prototype.clauseForDimension=function(e){return this.clauses.find(function(t){return t.dimension===e})};e.prototype.filteredOn=function(e){return this.indexOfClause(e)!==-1};e.prototype.filteredOnValue=function(e,t){var r=this.clauses;var n=this.indexOfClause(e);if(n===-1)return false;var i=r[n].getLiteralSet();return i?i.contains(t):false};e.prototype.isSelectionFilter=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return false;return t[r].action==="overlap"};e.prototype.addValue=function(t,r){var n=this.clauses;var i=this.indexOfClause(t);if(i===-1){return new e(n.concat(new filter_clause_1.FilterClause({dimension:t,selection:plywood_1.r(plywood_1.Set.fromJS([r]))})))}else{var s=n[i];var a=n[i].getLiteralSet();if(!a)throw new Error("can not add value to a non selection clause");var u=a.add(r);return new e(immutable_class_1.SimpleArray.change(n,i,s.changeSelection(plywood_1.r(u))))}};e.prototype.remove=function(t){var r=this.clauses;var n=this.indexOfClause(t);if(n===-1)return this;return new e(immutable_class_1.SimpleArray.deleteIndex(r,n))};e.prototype.removeValue=function(t,r){var n=this.clauses;var i=this.indexOfClause(t);if(i===-1)return this;var s=n[i];var a=n[i].getLiteralSet();if(!a)throw new Error("can not remove value of non selection clause");var u=a.remove(r);if(u.empty()){return new e(immutable_class_1.SimpleArray.deleteIndex(n,i))}else{n=immutable_class_1.SimpleArray.change(n,i,s.changeSelection(plywood_1.r(u)));return new e(n)}};e.prototype.toggleValue=function(e,t){var r=this.filteredOn(e)&&!this.isSelectionFilter(e)?this.remove(e):this;return r.filteredOnValue(e,t)?r.removeValue(e,t):r.addValue(e,t)};e.prototype.getSelection=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].selection};e.prototype.setSelection=function(t,r){var n=this.clauses;var i=this.indexOfClause(t);var s=new filter_clause_1.FilterClause({action:"overlap",dimension:t,selection:r});if(i===-1){n=immutable_class_1.SimpleArray.append(n,s)}else{n=immutable_class_1.SimpleArray.change(n,i,s)}return new e(n)};e.prototype.getExtent=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].getExtent()};e.prototype.getFileString=function(e){var t=this.clauses.length;var r=this.getExtent(e);var n=function(e){return e===0?"":"_filters-"+e};if(r){var i=r.start,s=r.end;t--;return dateToFileString(i)+"_"+dateToFileString(s)+n(t)}return n(t)};e.prototype.getLiteralSet=function(e){var t=this.clauses;var r=this.indexOfClause(e);if(r===-1)return null;return t[r].getLiteralSet()};e.prototype.getModeFor=function(t){var r=this.clauses;var n=this.indexOfClause(t);if(n===-1)return null;var i=r[n];if(i.action==="match")return e.REGEX;if(i.action==="contains")return e.CONTAINS;if(i.exclude)return e.EXCLUDE;return e.INCLUDE};e.prototype.toggleMode=function(){var e=this.clauses;if(e.length===0)return this;var t=e[0].exclude;for(var r=0;r<e.length;r++){if(e[r].exclude!==t){throw new Error("Heterogeneous filter modes, can't toggle")}}return this.changeClauses(e.map(function(e){return e.changeExclude(!t)}))};e.prototype.changeClauses=function(t){return new e(t)};e.prototype.setClause=function(t){var r=t.dimension;var n=false;var i=this.clauses.map(function(e){if(e.dimension===r){n=true;return t}else{return e}});if(!n){i=immutable_class_1.SimpleArray.append(i,t)}return new e(i)};e.prototype.applyDelta=function(e){var t=this;var r=e.clauses;r.forEach(function(e){t=t.setClause(e)});return t};e.prototype.getSingleClauseSet=function(){var e=this.clauses;if(e.length!==1)return null;return e[0].getLiteralSet()};e.prototype.constrainToDimensions=function(t,r,n){if(n===void 0){n=null}var i=false;var s=[];var a=r.name;var u=n?n.name:null;this.clauses.forEach(function(e){var o=e.dimension;if(immutable_class_1.NamedArray.findByName(t,o)){s.push(e)}else{i=true;if(r&&n&&u===o){s.push(new filter_clause_1.FilterClause({dimension:a,selection:e.selection}))}}});return i?new e(s):this};e.prototype.setExclusionForDimension=function(t,r){var n=this.clauses.map(function(e){if(!(e.dimension===t.name))return e;return e.changeExclude(r)});return new e(n)};e.EXCLUDE="exclude";e.INCLUDE="include";e.REGEX="regex";e.CONTAINS="contains";return e}();exports.Filter=Filter;check=Filter;Filter.EMPTY=new Filter([]);