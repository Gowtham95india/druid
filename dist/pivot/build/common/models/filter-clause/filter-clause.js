"use strict";var chronoshift_1=require("chronoshift");var plywood_1=require("plywood");var strings_1=require("../../utils/constants/strings");function isLiteral(e){if(e instanceof plywood_1.LiteralExpression)return plywood_1.TimeRange.isTimeRange(e.value)||plywood_1.Set.isSet(e.value)||plywood_1.NumberRange.isNumberRange(e.value);return false}function isRelative(e){if(e.type!=="TIME_RANGE")return false;return e instanceof plywood_1.ChainableExpression}function selectionsEqual(e,n){if(!Boolean(e)===Boolean(n))return false;if(e===n)return true;if(!e!==!n)return false;if(typeof e!==typeof n)return false;if(typeof e==="string"&&typeof n==="string")return e===n;return e.equals(n)}var check;var FilterClause=function(){function e(e){var n=e.dimension,t=e.selection,i=e.exclude,o=e.action;this.action=o||"overlap";this.dimension=n;if(isRelative(t)){this.relative=true}else if(isLiteral(t)){this.relative=false}else if(o==="match"&&typeof t!=="string"){throw new Error("invalid match selection: "+t)}else if(o==="contains"&&!(t instanceof plywood_1.Expression)){throw new Error("invalid contains expression: "+t)}this.selection=t;this.exclude=i||false}e.isFilterClause=function(n){return n instanceof e};e.evaluate=function(n,t,i,o){if(!n)return null;var s=chronoshift_1.minute.ceil(i||t,o);var r={};r[e.NOW_REF_NAME]=t;r[e.MAX_TIME_REF_NAME]=s;return n.defineEnvironment({timezone:o}).getFn()(r)};e.fromExpression=function(n){var t=false;if(n instanceof plywood_1.NotExpression){n=n.operand;t=true}var i;if(n instanceof plywood_1.ChainableExpression){if(n.operand instanceof plywood_1.RefExpression){i=n.operand.name}else{throw new Error("must be a ref "+n.operand)}}else{throw new Error("must be a chainable expression "+n)}if(n instanceof plywood_1.InExpression||n instanceof plywood_1.OverlapExpression||n instanceof plywood_1.ContainsExpression){var o=n.expression;var s=n.op;return new e({action:s==="in"?"overlap":s,dimension:i,selection:o,exclude:t})}if(n instanceof plywood_1.MatchExpression){return new e({action:"match",dimension:i,selection:n.regexp,exclude:t})}throw new Error("invalid expression "+n.toString())};e.fromJS=function(n){var t=n.selection,i=n.action;var o=n.dimension;if(!o&&n.expression){o=n.expression.name}var s={action:i,dimension:o,selection:typeof t!=="string"?plywood_1.Expression.fromJS(t):t,exclude:Boolean(n.exclude)};return new e(s)};e.prototype.valueOf=function(){return{action:this.action,dimension:this.dimension,selection:this.selection,exclude:this.exclude}};e.prototype.toJS=function(){var e=this,n=e.selection,t=e.action;var i={dimension:this.dimension,selection:n instanceof plywood_1.Expression?n.toJS():n};if(this.exclude)i.exclude=true;if(t)i.action=t;return i};e.prototype.toJSON=function(){return this.toJS()};e.prototype.toString=function(){return"[FilterClause: "+this.dimension+"]"};e.prototype.equals=function(n){return e.isFilterClause(n)&&this.action===n.action&&this.dimension===n.dimension&&selectionsEqual(this.selection,n.selection)&&this.exclude===n.exclude};e.prototype.toExpression=function(){var e=this,n=e.dimension,t=e.selection,i=e.action;var o=null;if(t instanceof plywood_1.Expression){var s=t.type;if(s==="TIME_RANGE"||s==="SET/TIME_RANGE"||s==="NUMBER_RANGE"||s==="SET/NUMBER_RANGE"){o=plywood_1.$(n).in(t)}else if(i==="contains"){o=plywood_1.$(n).contains(t)}else{o=plywood_1.$(n).overlap(t)}}else if(i==="match"){o=plywood_1.$(n).match(t)}if(this.exclude)o=o.not();return o};e.prototype.getLiteralSet=function(){var e=this,n=e.action,t=e.selection;if(n!=="overlap")return null;if(t instanceof plywood_1.Expression){var i=t.getLiteralValue();if(!i)return null;return plywood_1.Set.isSet(i)?i:plywood_1.Set.fromJS([i])}else{return null}};e.prototype.getExtent=function(){var e=this.getLiteralSet();return e?e.extent():null};e.prototype.isLessThanFullDay=function(){var e=this.getExtent();if(!e)return false;return e.end.valueOf()-e.start.valueOf()<chronoshift_1.day.canonicalLength};e.prototype.changeSelection=function(n){var t=this.valueOf();t.selection=n;return new e(t)};e.prototype.changeExclude=function(n){var t=this.valueOf();t.exclude=n;return new e(t)};e.prototype.evaluate=function(n,t,i){if(!this.relative)return this;return this.changeSelection(plywood_1.r(e.evaluate(this.selection,n,t,i)))};e.NOW_REF_NAME="n";e.MAX_TIME_REF_NAME="m";e.$maxTime=plywood_1.$(e.MAX_TIME_REF_NAME);e.$now=plywood_1.$(e.NOW_REF_NAME);e.LATEST_PRESETS=[{name:"1H",selection:e.$maxTime.timeRange("PT1H",-1),label:strings_1.STRINGS.latest+" "+strings_1.STRINGS.hour},{name:"6H",selection:e.$maxTime.timeRange("PT6H",-1),label:strings_1.STRINGS.latest+" 6 "+strings_1.STRINGS.hours},{name:"1D",selection:e.$maxTime.timeRange("P1D",-1),label:strings_1.STRINGS.latest+" "+strings_1.STRINGS.day},{name:"7D",selection:e.$maxTime.timeRange("P1D",-7),label:strings_1.STRINGS.latest+" 7 "+strings_1.STRINGS.days},{name:"30D",selection:e.$maxTime.timeRange("P1D",-30),label:strings_1.STRINGS.latest+" 30 "+strings_1.STRINGS.days}];e.CURRENT_PRESETS=[{name:"D",selection:e.$now.timeBucket("P1D"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.day},{name:"W",selection:e.$now.timeBucket("P1W"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.week},{name:"M",selection:e.$now.timeBucket("P1M"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.month},{name:"Q",selection:e.$now.timeBucket("P3M"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.quarter},{name:"Y",selection:e.$now.timeBucket("P1Y"),label:strings_1.STRINGS.current+" "+strings_1.STRINGS.year}];e.PREVIOUS_PRESETS=[{name:"D",selection:e.$now.timeFloor("P1D").timeRange("P1D",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.day},{name:"W",selection:e.$now.timeFloor("P1W").timeRange("P1W",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.week},{name:"M",selection:e.$now.timeFloor("P1M").timeRange("P1M",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.month},{name:"Q",selection:e.$now.timeFloor("P3M").timeRange("P3M",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.quarter},{name:"Y",selection:e.$now.timeFloor("P1Y").timeRange("P1Y",-1),label:strings_1.STRINGS.previous+" "+strings_1.STRINGS.year}];return e}();exports.FilterClause=FilterClause;check=FilterClause;