"use strict";var immutable_class_1=require("immutable-class");var immutable_class_2=require("immutable-class");var general_1=require("../../utils/general/general");var cluster_1=require("../cluster/cluster");var customization_1=require("../customization/customization");var data_cube_1=require("../data-cube/data-cube");var collection_1=require("../collection/collection");var user_1=require("../user/user");var string_1=require("../../utils/string/string");function checkNamedArrayUnique(t){var e={};for(var r=0,s=t;r<s.length;r++){var i=s[r];var a=i.name;if(e[a])throw new Error("duplicate '"+a+"'");e[a]=1}}var check;var AppSettings=function(){function t(t){var e=t.version,r=t.clusters,s=t.customization,i=t.dataCubes,a=t.linkViewConfig,n=t.collections,u=t.users;for(var o=0,l=i;o<l.length;o++){var c=l[o];if(c.clusterName==="native")continue;if(!immutable_class_2.NamedArray.findByName(r,c.clusterName)){throw new Error("data cube '"+c.name+"' refers to an unknown cluster '"+c.clusterName+"'")}}this.version=e||0;this.clusters=r;checkNamedArrayUnique(this.clusters);this.customization=s;this.dataCubes=i;checkNamedArrayUnique(this.dataCubes);this.linkViewConfig=a;this.collections=n;checkNamedArrayUnique(this.collections);this.users=u;if(u)checkNamedArrayUnique(u)}t.isAppSettings=function(e){return e instanceof t};t.fromJS=function(e,r){if(!r)throw new Error("AppSettings must have context");var s=e.collections,i=e.users;var a;if(e.clusters){a=e.clusters.map(function(t){return cluster_1.Cluster.fromJS(t)})}else if(general_1.hasOwnProperty(e,"druidHost")||general_1.hasOwnProperty(e,"brokerHost")){var n=JSON.parse(JSON.stringify(e));n.name="druid";n.type="druid";n.host=n.druidHost||n.brokerHost;a=[cluster_1.Cluster.fromJS(n)]}else{a=[]}var u=(e.dataCubes||e.dataSources||[]).map(function(t){var e=t.clusterName||t.engine;if(e!=="native"){var r=immutable_class_2.NamedArray.findByName(a,e);if(!r)throw new Error("DataCube '"+t.name+"' refers to a non existent cluster '"+e+"'")}return data_cube_1.DataCube.fromJS(t)});var o={dataCubes:u,visualizations:r.visualizations};var l=function(t){return t?collection_1.Collection.fromJS(t,o):null};var c={version:e.version,clusters:a,customization:customization_1.Customization.fromJS(e.customization||{}),dataCubes:u,linkViewConfig:l(e.linkViewConfig),collections:s?s.map(l).filter(Boolean):[],users:i?i.map(user_1.User.fromJS):[]};return new t(c)};t.prototype.valueOf=function(){return{version:this.version,clusters:this.clusters,customization:this.customization,dataCubes:this.dataCubes,linkViewConfig:this.linkViewConfig,collections:this.collections,users:this.users}};t.prototype.toJS=function(){var t={};if(this.version)t.version=this.version;t.clusters=this.clusters.map(function(t){return t.toJS()});t.customization=this.customization.toJS();t.dataCubes=this.dataCubes.map(function(t){return t.toJS()});if(this.collections.length>0)t.collections=this.collections.map(function(t){return t.toJS()});if(this.linkViewConfig)t.linkViewConfig=this.linkViewConfig.toJS();if(this.users&&this.users.length>0)t.users=this.users.map(function(t){return t.toJS()});return t};t.prototype.toJSON=function(){return this.toJS()};t.prototype.toString=function(){return"[AppSettings v"+this.version+" dataCubes="+this.dataCubes.length+"]"};t.prototype.equals=function(e){return t.isAppSettings(e)&&this.version===e.version&&immutable_class_1.immutableArraysEqual(this.clusters,e.clusters)&&immutable_class_1.immutableEqual(this.customization,e.customization)&&immutable_class_1.immutableArraysEqual(this.dataCubes,e.dataCubes)&&immutable_class_1.immutableEqual(this.linkViewConfig,e.linkViewConfig)&&immutable_class_1.immutableArraysEqual(this.collections,e.collections)&&immutable_class_1.immutableArraysEqual(this.users,e.users)};t.prototype.toClientSettings=function(){var e=this.valueOf();e.clusters=e.clusters.map(function(t){return t.toClientCluster()});e.dataCubes=e.dataCubes.map(function(t){return t.toClientDataCube()});delete e.users;return new t(e)};t.prototype.getVersion=function(){return this.version};t.prototype.incrementVersion=function(){var e=this.valueOf();e.version++;return new t(e)};t.prototype.getCollectionsInvolvingCluster=function(t){var e=this.getDataCubesByCluster(t);return this.collections.filter(function(t){return e.some(function(e){return t.dependsOnDataCube(e.name)})})};t.prototype.incomplete=function(){return this.dataCubes.some(function(t){return t.incomplete()})};t.prototype.getDataCubesByCluster=function(t){return this.dataCubes.filter(function(e){return e.clusterName===t})};t.prototype.getDataCubesByClusterSource=function(t,e){return this.dataCubes.filter(function(r){return r.clusterName===t&&r.source===e})};t.prototype.getDataCube=function(t){return immutable_class_2.NamedArray.findByName(this.dataCubes,t)};t.prototype.getCluster=function(t){return immutable_class_2.NamedArray.findByName(this.clusters,t)};t.prototype.getUsers=function(){var t=this.users;return t&&t.length?t:[user_1.User.DEFAULT_ADMIN]};t.prototype.getUser=function(t){return immutable_class_2.NamedArray.findByName(this.getUsers(),t)};t.prototype.change=function(t,e){return this["change"+string_1.firstUp(t)](e)};t.prototype.changeCustomization=function(e){var r=this.valueOf();r.customization=e;return new t(r)};t.prototype.changeClusters=function(e){var r=this.valueOf();r.clusters=e;var s=r.dataCubes.filter(function(t){if(t.clusterName==="native")return true;return immutable_class_2.NamedArray.containsByName(e,t.clusterName)});r.dataCubes=s;r.collections=r.collections.map(function(t){return t.constrainTilesToDataCubes(s)});return new t(r)};t.prototype.deleteCluster=function(t){return this.changeClusters(immutable_class_2.NamedArray.deleteByName(this.clusters,t))};t.prototype.addOrUpdateCluster=function(t){return this.changeClusters(immutable_class_2.NamedArray.overrideByName(this.clusters,t))};t.prototype.changeDataCubes=function(e){var r=this.valueOf();r.dataCubes=e;r.collections=r.collections.map(function(t){return t.constrainTilesToDataCubes(e)});return new t(r)};t.prototype.appendDataCubes=function(t){return this.changeDataCubes(immutable_class_2.NamedArray.overridesByName(this.dataCubes,t))};t.prototype.addOrUpdateDataCube=function(t){return this.changeDataCubes(immutable_class_2.NamedArray.overrideByName(this.dataCubes,t))};t.prototype.deleteDataCube=function(t){return this.changeDataCubes(immutable_class_2.NamedArray.deleteByName(this.dataCubes,t))};t.prototype.filterDataCubes=function(t){return this.changeDataCubes(this.dataCubes.filter(t))};t.prototype.changeCollections=function(e){var r=this.valueOf();r.collections=e;return new t(r)};t.prototype.addOrUpdateCollection=function(t){return this.changeCollections(immutable_class_2.NamedArray.overrideByName(this.collections,t))};t.prototype.deleteCollection=function(t){return this.changeCollections(immutable_class_2.NamedArray.deleteByName(this.collections,t))};t.prototype.addCollectionAt=function(t,e){var r=this.collections.slice();r.splice(e,0,t);return this.changeCollections(r)};t.prototype.changeUsers=function(e){var r=this.valueOf();r.users=e;return new t(r)};t.prototype.addOrUpdateUser=function(t){return this.changeUsers(immutable_class_2.NamedArray.overrideByName(this.getUsers(),t))};t.prototype.appendUsers=function(t){return this.changeUsers(immutable_class_2.NamedArray.overridesByName(this.getUsers(),t))};t.prototype.deleteUser=function(t){return this.changeUsers(immutable_class_2.NamedArray.deleteByName(this.getUsers(),t))};t.prototype.updateUserPass=function(t,e){return t.updatePass(e).then(this.addOrUpdateUser.bind(this))};t.BLANK=t.fromJS({},{visualizations:[]});return t}();exports.AppSettings=AppSettings;check=AppSettings;