"use strict";var lz_string_1=require("lz-string");var immutable_class_1=require("immutable-class");var chronoshift_1=require("chronoshift");var general_1=require("../../../common/utils/general/general");var filter_1=require("../filter/filter");var filter_clause_1=require("../filter-clause/filter-clause");var highlight_1=require("../highlight/highlight");var splits_1=require("../splits/splits");var colors_1=require("../colors/colors");var HASH_VERSION=2;function constrainDimensions(e,t){return e.filter(function(e){return Boolean(t.getDimension(e))})}function constrainMeasures(e,t){return e.filter(function(e){return Boolean(t.getMeasure(e))})}function addToSetInOrder(e,t,i){return e.filter(function(e){return t.indexOf(e)!==-1||e===i})}(function(e){e[e["FairGame"]=0]="FairGame";e[e["UnfairGame"]=1]="UnfairGame";e[e["KeepAlways"]=2]="KeepAlways"})(exports.VisStrategy||(exports.VisStrategy={}));var VisStrategy=exports.VisStrategy;var check;var Essence=function(){function e(t){var i=t.visualizations,r=t.dataCube,s=t.visualization,n=t.timezone,a=t.filter,o=t.splits,l=t.multiMeasureMode,u=t.singleMeasure,h=t.selectedMeasures,f=t.pinnedDimensions,p=t.colors,c=t.pinnedSort,g=t.compare,m=t.highlight;if(!r)throw new Error("Essence must have a dataCube");n=n||chronoshift_1.Timezone.UTC;if(!a){a=r.getDefaultFilter()}l=Boolean(l);function d(e){return l?immutable_class_1.SimpleArray.contains(h,e):e===u}if(m&&m.measure&&!d(m.measure)){m=null}var v=null;if(i){var M=u||r.getDefaultSortMeasure();if(!s){s=e.getBestVisualization(i,r,o,a,M,p,null).visualization}var S=r.getSplitableDimensions();v=s.canHandleSplitDimensions(r,o.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(S,e.dimension)}),a,M);if(v.proceedWithDimensions()){var y=s.getSuitability(r,o,p,t.visualization===s);if(y.cantHandleCombine)v=y.cantHandleCombine}}this.visualizations=i;this.visualization=s;this.dataCube=r;this.timezone=n;this.filter=a;this.splits=o;this.multiMeasureMode=l;this.singleMeasure=u;this.selectedMeasures=h;this.pinnedDimensions=f;this.colors=p;this.pinnedSort=c;this.highlight=m;this.compare=g;this.visResolve=v}e.isEssence=function(t){return t instanceof e};e.getBestVisualization=function(e,t,i,r,s,n,a){var o=a?a.name:null;var l=t.getSplitableDimensions();var u=i.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(l,e.dimension)});var h=e.filter(function(e){return e.canHandleSplitDimensions(t,u,r,s).proceedWithDimensions()});return h.map(function(e){return{suitability:e.getSuitability(t,i,n,e.name===o),visualization:e}}).sort(function(e,t){return t.suitability.score-e.suitability.score})[0]};e.fromHash=function(t,i){var r=t.split("/");if(r.length<3)return null;var s=r.shift();var n=parseInt(r.shift(),10);if(n>HASH_VERSION)return null;var a=null;try{a=JSON.parse("["+lz_string_1.decompressFromBase64(r.join("/"))+"]")}catch(e){return null}if(!Array.isArray(a))return null;if(n===1){a.splice(3,0,false,null)}var o=a.length;if(!(8<=o&&o<=11))return null;var l;try{l=e.fromJS({visualization:s,timezone:a[0],filter:a[1],splits:a[2],multiMeasureMode:a[3],singleMeasure:a[4],selectedMeasures:a[5],pinnedDimensions:a[6],pinnedSort:a[7],colors:a[8]||null,compare:a[9]||null,highlight:a[10]||null},i)}catch(e){return null}return l};e.fromDataCube=function(t,i){var r=t.getDefaultSplits();var s=t.getDefaultFilter();var n=r.initializeGivenFilter(s,t.getSplitableDimensions(),t.getDefaultSortMeasure());return new e({dataCube:i.dataCube,visualizations:i.visualizations,visualization:null,timezone:t.getDefaultTimezone(),filter:t.getDefaultFilter(),splits:n,multiMeasureMode:false,singleMeasure:t.getDefaultSortMeasure(),selectedMeasures:t.getDefaultSelectedMeasures(),pinnedDimensions:t.getDefaultPinnedDimensions(),colors:null,pinnedSort:t.getDefaultSortMeasure(),compare:null,highlight:null})};e.fromJS=function(t,i){if(!i)throw new Error("Essence must have context");var r=i.dataCube,s=i.visualizations;var n=t.visualization;if(n==="time-series")n="line-chart";var a=immutable_class_1.NamedArray.findByName(s,n);var o=t.timezone?chronoshift_1.Timezone.fromJS(t.timezone):null;var l=t.filter?filter_1.Filter.fromJS(t.filter).constrainToDimensions(r.getSplitableDimensions(),r.getSpecialTimeExpression()):null;var u={dimensions:r.getSplitableDimensions(),measure:t.singleMeasure||r.getDefaultSortMeasure()};var h=splits_1.Splits.fromJS(t.splits||[],u).constrainToDimensionsAndMeasures(r.getSplitableDimensions(),r.getMeasures());var f=r.getDefaultSortMeasure();var p=general_1.hasOwnProperty(t,"multiMeasureMode")?t.multiMeasureMode:!general_1.hasOwnProperty(t,"singleMeasure");var c=r.getMeasure(t.singleMeasure)?t.singleMeasure:f;var g=constrainMeasures(t.selectedMeasures||[],r);var m=constrainDimensions(t.pinnedDimensions||[],r);var d=t.colors?colors_1.Colors.fromJS(t.colors):null;var v=r.getMeasure(t.pinnedSort)?t.pinnedSort:f;var M=null;var S=t.compare;if(S){M=filter_1.Filter.fromJS(S).constrainToDimensions(r.getSplitableDimensions(),r.getSpecialTimeExpression())}var y=null;var b=t.highlight;if(b){y=highlight_1.Highlight.fromJS(b).constrainToDimensions(r.getSplitableDimensions(),r.getSpecialTimeExpression())}return new e({dataCube:r,visualizations:s,visualization:a,timezone:o,filter:l,splits:h,multiMeasureMode:p,singleMeasure:c,selectedMeasures:g,pinnedDimensions:m,colors:d,pinnedSort:v,compare:M,highlight:y})};e.prototype.valueOf=function(){return{dataCube:this.dataCube,visualizations:this.visualizations,visualization:this.visualization,timezone:this.timezone,filter:this.filter,splits:this.splits,multiMeasureMode:this.multiMeasureMode,singleMeasure:this.singleMeasure,selectedMeasures:this.selectedMeasures,pinnedDimensions:this.pinnedDimensions,colors:this.colors,pinnedSort:this.pinnedSort,compare:this.compare,highlight:this.highlight}};e.prototype.toJS=function(){var e={visualization:this.visualization.name,timezone:this.timezone.toJS(),filter:this.filter.toJS(),splits:this.splits.toJS(),singleMeasure:this.singleMeasure,selectedMeasures:this.selectedMeasures,pinnedDimensions:this.pinnedDimensions};if(this.multiMeasureMode)e.multiMeasureMode=true;if(this.colors)e.colors=this.colors.toJS();var t=this.dataCube.getDefaultSortMeasure();if(this.pinnedSort!==t)e.pinnedSort=this.pinnedSort;if(this.compare)e.compare=this.compare.toJS();if(this.highlight)e.highlight=this.highlight.toJS();return e};e.prototype.toJSON=function(){return this.toJS()};e.prototype.toString=function(){return"[Essence]"};e.prototype.equals=function(t){return e.isEssence(t)&&this.dataCube.equals(t.dataCube)&&this.visualization.name===t.visualization.name&&this.timezone.equals(t.timezone)&&this.filter.equals(t.filter)&&this.splits.equals(t.splits)&&this.multiMeasureMode===t.multiMeasureMode&&this.singleMeasure===t.singleMeasure&&immutable_class_1.generalArraysEqual(this.selectedMeasures,t.selectedMeasures)&&immutable_class_1.generalArraysEqual(this.pinnedDimensions,t.pinnedDimensions)&&immutable_class_1.immutableEqual(this.colors,t.colors)&&this.pinnedSort===t.pinnedSort&&immutable_class_1.immutableEqual(this.compare,t.compare)&&immutable_class_1.immutableEqual(this.highlight,t.highlight)};e.prototype.toHash=function(){var e=this.toJS();var t=[e.timezone,e.filter,e.splits,e.multiMeasureMode,e.singleMeasure,e.selectedMeasures,e.pinnedDimensions,e.pinnedSort];if(e.colors)t[8]=e.colors;if(e.compare)t[9]=e.compare;if(e.highlight)t[10]=e.highlight;var i=[];for(var r=0;r<t.length;r++){i.push(JSON.stringify(t[r]||null))}return[e.visualization,HASH_VERSION,lz_string_1.compressToBase64(i.join(","))].join("/")};e.prototype.getURL=function(e){return e+this.toHash()};e.prototype.evaluateSelection=function(e,t){var i=this,r=i.timezone,s=i.dataCube;return filter_clause_1.FilterClause.evaluate(e,t.now(),s.getMaxTime(t),r)};e.prototype.evaluateClause=function(e,t){var i=this,r=i.timezone,s=i.dataCube;return e.evaluate(t.now(),s.getMaxTime(t),r)};e.prototype.getEffectiveFilter=function(e,t,i){if(t===void 0){t=null}if(i===void 0){i=null}var r=this,s=r.dataCube,n=r.filter,a=r.highlight,o=r.timezone;if(a&&t!==a.owner)n=a.applyToFilter(n);if(i)n=n.remove(i.name);return n.getSpecificFilter(e.now(),s.getMaxTime(e),o)};e.prototype.getRealTimeSelection=function(){var e=this.dataCube.getSpecialTimeDimension();return this.filter.getSelection(e)};e.prototype.isFixedMeasureMode=function(){return this.visualization.measureModeNeed!=="any"};e.prototype.getEffectiveMultiMeasureMode=function(){var e=this.visualization.measureModeNeed;if(e!=="any"){return e==="multi"}return this.multiMeasureMode};e.prototype.getEffectiveMeasures=function(){if(this.getEffectiveMultiMeasureMode()){return this.getMeasures()}else{return[this.dataCube.getMeasure(this.singleMeasure)]}};e.prototype.getFirstSelectedMeasure=function(){var e=this.selectedMeasures;return e?e[0]:null};e.prototype.getMeasures=function(){var e=this.dataCube;return this.selectedMeasures.map(function(t){return e.getMeasure(t)})};e.prototype.getSortMeasure=function(){return(this.getEffectiveMultiMeasureMode()?this.getFirstSelectedMeasure():this.singleMeasure)||this.dataCube.getDefaultSortMeasure()};e.prototype.getEffectiveSelectedMeasure=function(){if(this.getEffectiveMultiMeasureMode()){return this.selectedMeasures}else{return[this.singleMeasure]}};e.prototype.differentDataCube=function(e){return this.dataCube!==e.dataCube};e.prototype.differentTimezone=function(e){return!this.timezone.equals(e.timezone)};e.prototype.differentTimezoneMatters=function(e){return this.splits.timezoneDependant()&&this.differentTimezone(e)};e.prototype.differentFilter=function(e){return!this.filter.equals(e.filter)};e.prototype.differentSplits=function(e){return!this.splits.equals(e.splits)};e.prototype.differentEffectiveSplits=function(e){return this.differentSplits(e)||this.differentTimezoneMatters(e)};e.prototype.differentColors=function(e){if(Boolean(this.colors)!==Boolean(e.colors))return true;if(!this.colors)return false;return!this.colors.equals(e.colors)};e.prototype.differentSelectedMeasures=function(e){return!immutable_class_1.generalArraysEqual(this.selectedMeasures,e.selectedMeasures)};e.prototype.differentEffectiveMeasures=function(e){return!immutable_class_1.generalArraysEqual(this.getEffectiveSelectedMeasure(),e.getEffectiveSelectedMeasure())};e.prototype.newSelectedMeasures=function(e){return!general_1.isSubset(this.selectedMeasures,e.selectedMeasures)};e.prototype.newEffectiveMeasures=function(e){return!general_1.isSubset(this.getEffectiveSelectedMeasure(),e.getEffectiveSelectedMeasure())};e.prototype.differentPinnedDimensions=function(e){return!immutable_class_1.generalArraysEqual(this.pinnedDimensions,e.pinnedDimensions)};e.prototype.differentPinnedSort=function(e){return this.pinnedSort!==e.pinnedSort};e.prototype.differentCompare=function(e){if(Boolean(this.compare)!==Boolean(e.compare))return true;return Boolean(this.compare&&!this.compare.equals(e.compare))};e.prototype.differentHighligh=function(e){if(Boolean(this.highlight)!==Boolean(e.highlight))return true;return Boolean(this.highlight&&!this.highlight.equals(e.highlight))};e.prototype.differentEffectiveFilter=function(e,t,i,r,s){if(r===void 0){r=null}if(s===void 0){s=null}var n=this.getEffectiveFilter(t,r,s);var a=e.getEffectiveFilter(i,r,s);return!n.equals(a)};e.prototype.highlightOn=function(e,t){var i=this.highlight;if(!i)return false;return i.owner===e&&(!t||i.measure===t)};e.prototype.highlightOnDifferentMeasure=function(e,t){var i=this.highlight;if(!i)return false;return i.owner===e&&t&&i.measure!==t};e.prototype.getSingleHighlightSet=function(){var e=this.highlight;if(!e)return null;return e.delta.getSingleClauseSet()};e.prototype.getApplyForSort=function(e){var t=e.expression.name;var i=this.dataCube.getMeasure(t);if(!i)return null;return i.toApplyAction()};e.prototype.updateDataCube=function(t){var i=this.dataCube;if(i.equals(t))return this;var r=t.getSpecialTimeExpression();var s=i.getSpecialTimeExpression();var n=this.valueOf();n.dataCube=t;n.filter=n.filter.constrainToDimensions(t.getDimensions(),r,s);n.splits=n.splits.constrainToDimensionsAndMeasures(t.getDimensions(),t.getMeasures());n.selectedMeasures=constrainMeasures(n.selectedMeasures,t);if(n.selectedMeasures.length===0){n.selectedMeasures=t.getDefaultSelectedMeasures()}n.pinnedDimensions=constrainDimensions(n.pinnedDimensions,t);if(n.colors&&!t.getDimension(n.colors.dimension)){n.colors=null}if(!t.getMeasure(n.pinnedSort))n.pinnedSort=t.getDefaultSortMeasure();if(n.compare){n.compare=n.compare.constrainToDimensions(t.getSplitableDimensions(),r,s)}if(n.highlight){n.highlight=n.highlight.constrainToDimensions(t.getSplitableDimensions(),r,s)}return new e(n)};e.prototype.changeFilter=function(t,i){if(i===void 0){i=false}var r=this.valueOf();r.filter=t;if(i){r.highlight=null}return new e(r).updateSplitsWithFilterChange()};e.prototype.changeTimezone=function(t){var i=this.timezone;if(i===t)return this;var r=this.valueOf();r.timezone=t;return new e(r)};e.prototype.changeTimeSelection=function(e){var t=this.filter;var i=this.dataCube.getSpecialTimeDimension();if(!i)return this;return this.changeFilter(t.setSelection(i,e))};e.prototype.convertToSpecificFilter=function(e){var t=this,i=t.dataCube,r=t.filter,s=t.timezone;if(!r.isRelative())return this;return this.changeFilter(r.getSpecificFilter(e.now(),i.getMaxTime(e),s))};e.prototype.getEffectiveColors=function(){var e=this,t=e.visualization,i=e.splits,r=e.dataCube,s=e.colors;if(!t)return null;return t.getEffectiveColors(r,i,s)};e.prototype.getEffectiveSplits=function(){var e=this,t=e.visualization,i=e.splits;if(!t)return null;return t.getEffectiveSplits(i)};e.prototype.getEffectiveSplitForDimension=function(e){return this.getEffectiveSplits().findSplitForDimension(e)};e.prototype.updateWithNewSplits=function(t,i){var r=this,s=r.visualizations,n=r.dataCube,a=r.visualization,o=r.filter,l=r.colors;var u=this.splits;if(this.visResolve.rejectedDimensions()){var h=n.getSplitableDimensions();var f=t.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(h,e.dimension)});if(!a.canHandleSplitDimensions(n,f,o,this.getSortMeasure()).rejectedDimensions()){i=VisStrategy.KeepAlways}}if(u.onlyCombinesChanged(t)){i=VisStrategy.KeepAlways}if(i==null)i=u.getStrategyForSplitChange(t);if(i!==VisStrategy.KeepAlways){var p=e.getBestVisualization(s,n,t,o,this.getSortMeasure(),l,i===VisStrategy.FairGame?null:a);a=p.visualization}var c=this.valueOf();c.splits=t;c.visualization=a;if(c.highlight){c.filter=c.highlight.applyToFilter(c.filter);c.highlight=null}return new e(c)};e.prototype.changeSplit=function(e,t){var i=this.splits;var r=i.splitCombines.find(function(t){return t.dimension===e.dimension});var s=i.replace(r,e);return this.updateWithNewSplits(s,t)};e.prototype.addSplit=function(e,t){var i=this.splits;return this.initializeSplits(i.addSplit(e),t)};e.prototype.initializeSplits=function(e,t){var i=this,r=i.dataCube,s=i.filter;var n=e.initializeGivenFilter(s,r.getSplitableDimensions(),this.getSortMeasure());return this.updateWithNewSplits(n,t)};e.prototype.removeSplit=function(e,t){var i=this.splits;var r=i.removeSplit(e);return this.initializeSplits(r)};e.prototype.updateSplitsWithFilterChange=function(){var t=this.valueOf();var i=t.splits,r=t.filter,s=t.dataCube;var n=i.recalculateBucketsWithFilterChange(r,s.getSplitableDimensions());if(i===n)return this;t.splits=n;return new e(t)};e.prototype.changeColors=function(t){var i=this.valueOf();i.colors=t;return new e(i)};e.prototype.summonVisualization=function(t){var i=this,r=i.dataCube,s=i.splits,n=i.filter,a=i.singleMeasure,o=i.colors;var l=r.getSplitableDimensions();var u=t.canHandleSplitDimensions(r,s.splitCombines.map(function(e){return immutable_class_1.NamedArray.findByName(l,e.dimension)}),n,this.getSortMeasure());var h=this.valueOf();if(u.proceedWithDimensions()){var f=t.summon(r,s,n,a,o);if(f){h.splits=f.splits;h.colors=f.colors}}h.visualization=t;return new e(h)};e.prototype.pin=function(t){var i=this.valueOf();i.pinnedDimensions=immutable_class_1.SimpleArray.append(i.pinnedDimensions,t.name);return new e(i)};e.prototype.unpin=function(t){var i=this.valueOf();i.pinnedDimensions=immutable_class_1.SimpleArray.delete(i.pinnedDimensions,t.name);return new e(i)};e.prototype.getPinnedSortMeasure=function(){return this.dataCube.getMeasure(this.pinnedSort)};e.prototype.changePinnedSortMeasure=function(t){var i=this.valueOf();i.pinnedSort=t.name;return new e(i)};e.prototype.switchToMeasure=function(e){var t=this.changeSingleMeasure(e);return t.multiMeasureMode?t.toggleMultiMeasureMode():t};e.prototype.toggleMultiMeasureMode=function(){var t=this,i=t.dataCube,r=t.multiMeasureMode,s=t.selectedMeasures,n=t.singleMeasure;var a=this.valueOf();a.multiMeasureMode=!r;if(r){if(s.length&&s.indexOf(n)===-1){a.singleMeasure=s[0]}}else{a.selectedMeasures=addToSetInOrder(i.getMeasures().map(function(e){return e.name}),a.selectedMeasures,n)}return new e(a)};e.prototype.changeSingleMeasure=function(t){if(t.name===this.singleMeasure)return this;var i=this.valueOf();i.singleMeasure=t.name;i.splits=i.splits.changeSortIfOnMeasure(this.singleMeasure,t.name);i.pinnedSort=t.name;return new e(i)};e.prototype.toggleSelectedMeasure=function(t){var i=this.dataCube;var r=this.valueOf();var s=r.selectedMeasures;var n=t.name;if(s.indexOf(n)!==-1){r.selectedMeasures=immutable_class_1.SimpleArray.delete(s,n)}else{r.selectedMeasures=addToSetInOrder(i.getMeasures().map(function(e){return e.name}),s,n)}return new e(r)};e.prototype.toggleEffectiveMeasure=function(e){if(this.getEffectiveMultiMeasureMode()){return this.toggleSelectedMeasure(e)}else{return this.changeSingleMeasure(e)}};e.prototype.acceptHighlight=function(){var e=this.highlight;if(!e)return this;return this.changeFilter(e.applyToFilter(this.filter),true)};e.prototype.changeHighlight=function(t,i,r){var s=this.highlight;var n;if(s&&s.owner!==t){n=this.changeFilter(s.applyToFilter(this.filter)).valueOf()}else{n=this.valueOf()}n.highlight=new highlight_1.Highlight({owner:t,delta:r,measure:i});return new e(n)};e.prototype.dropHighlight=function(){var t=this.valueOf();t.highlight=null;return new e(t)};e.prototype.canInvertHighlight=function(){var e=this,t=e.highlight,i=e.dataCube;if(!t)return false;if(i.getDimension(t.delta.clauses[0].dimension).isContinuous())return false;return true};e.prototype.invertHighlight=function(){var e=this.highlight;return this.changeHighlight(e.owner,e.measure,e.delta.toggleMode())};return e}();exports.Essence=Essence;check=Essence;