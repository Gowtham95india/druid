"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var plywood_1=require("plywood");var config_1=require("../../config");var router=nike_hercules_1.HerculesServer.makeRouter();var outputFunctions={json:function(e){return JSON.stringify(e,null,2)},csv:function(e){return e.toCSV()},tsv:function(e){return e.toTSV()}};router.post("/",function(e,t){var r=e.body,n=r.outputType,u=r.query;if(config_1.LICENSE_MANGER.isExpired()){t.status(501).send({error:"evaluation expired"});return}if(typeof u!=="string"){var s="Query must be a string";t.status(400).send(s);return}var o;try{o=plywood_1.Expression.parseSQL(u)}catch(e){var s="Could not parse query as SQL: "+e.message;t.status(400).send(s);return}if(typeof n!=="string"){n="json"}var a;a=outputFunctions[n];if(a===undefined){var s="Invalid output type: "+n;t.status(400).send(s);return}var i=o.expression;var d=o.table;if(!d){var s="Could not determine data cube name";t.status(400).send(s);return}i=i.substitute(function(e){if(e instanceof plywood_1.RefExpression&&e.name===d){return plywood_1.$("main")}return null});e.getFullSettings({dataCubeOfInterest:d}).then(function(e){var r=e.appSettings,u=e.executors;var s=r.getDataCube(d);if(!s){t.status(400).send({error:"unknown data cube"});return null}var o=u[s.name];if(!o){t.status(400).send({error:"unqueryable data cube"});return null}return o(i).then(function(e){t.type(n);t.send(a(plywood_1.Dataset.fromJS(e.toJS())))},function(e){t.status(500).send("got error "+e.message)})}).done()});module.exports=router;