"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var config_1=require("../../config");var token_manager_1=require("../../utils/token-manager/token-manager");function sendUpdateError(e,r){console.log("error:",r.message);if(r.hasOwnProperty("stack")){console.log(r.stack)}e.status(500).send({error:"could not update",message:r.message})}var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/",function(e,r,n){var t=e.body,o=t.name,s=t.pass;if(typeof o!=="string"){r.status(400).send({error:"must have a name"});return}if(typeof s!=="string"){r.status(400).send({error:"must have a pass"});return}e.getFullSettings().then(function(e){var r=e.appSettings;var n=r.getUser(o);if(!n)throw new Error("no such user");return r.updateUserPass(n,s)}).then(function(e){return config_1.SETTINGS_MANAGER.updateSettings(e.incrementVersion())}).then(function(){r.send({status:"ok"})},function(e){sendUpdateError(r,e)}).done()});router.post("/mklink",function(e,r,n){var t=e.body.name;if(typeof t!=="string"){r.status(400).send({error:"must have a name"});return}var o=token_manager_1.TokenManager.makeToken();config_1.TOKEN_MANAGER.setToken(t,o).then(function(){var n=e.protocol+"://"+e.get("Host")+"/invite-user?user="+t+"&token="+o.token;r.send({link:n})}).catch(function(e){sendUpdateError(r,e)}).done()});module.exports=router;