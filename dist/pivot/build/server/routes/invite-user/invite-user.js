"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var user_1=require("../../../common/models/user/user");var strings_1=require("../../../common/utils/constants/strings");var config_1=require("../../config");var views_1=require("../../views");var config_2=require("../../config");var router=nike_hercules_1.HerculesServer.makeRouter();router.get("/",function(e,r,s){var n=e.query.user;var t=e.query.token;config_2.TOKEN_MANAGER.getTokenValue(n).then(function(e){if(e===t){r.send(views_1.inviteLayout({version:config_1.VERSION,title:strings_1.STRINGS.loginToPivot,user:n,inviteToken:e}))}else if(config_2.TOKEN_MANAGER.isUsed(n)){r.send("This link has expired.")}else{r.redirect("/")}}).catch(function(e){console.log("error:",JSON.stringify(e));if(e.hasOwnProperty("stack")){console.log(e.stack)}r.status(500).send({error:"Could not process link",message:e.message})}).done()});router.post("/accept",function(e,r,s){var n=e.body,t=n.name,o=n.pass,i=n.token;if(typeof t!=="string"){r.status(400).send({error:"must have a name"});return}if(typeof o!=="string"){r.status(400).send({error:"must have a pass"});return}if(typeof i!=="string"){r.status(400).send({error:"must have a token"});return}var u;e.getFullSettings().then(function(e){var r=e.appSettings;u=r.getUser(t);if(!u)throw new Error("no such user");u=u.changeStatus(user_1.User.STATUS_OK);return config_2.TOKEN_MANAGER.processToken(t,i).then(function(){return r.updateUserPass(u,o)})}).then(function(e){return config_2.SETTINGS_MANAGER.updateSettings(e.incrementVersion())}).then(function(){e.session["loggedIn"]=true;e.session["user"]=u;r.send({status:"ok"})},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}r.status(500).send({error:"could not update",message:e.message})}).done()});module.exports=router;