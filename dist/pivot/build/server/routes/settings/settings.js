"use strict";var nike_hercules_1=require("@implydata/nike-hercules");var index_1=require("../../../common/models/index");var index_2=require("../../../common/manifests/index");var config_1=require("../../config");var router=nike_hercules_1.HerculesServer.makeRouter();router.post("/load",function(e,s){var t=e.body.settingsVersion;config_1.SETTINGS_MANAGER.getFullSettings({expectedVersion:t}).then(function(e){s.send({appSettings:e.appSettings})},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}s.status(500).send({error:"could not compute",message:e.message})}).done()});router.post("/set",function(e,s){var t=e.body.appSettings;var r;try{r=index_1.AppSettings.fromJS(t,{visualizations:index_2.MANIFESTS})}catch(e){s.status(400).send({error:"bad settings",message:e.message});return}if(e.userMode==="native-users"&&e.user&&!r.getUser(e.user.name)){s.status(403).send({error:"user not in new settings"});return}config_1.SETTINGS_MANAGER.updateSettings(r).then(function(e){s.send({status:"ok",timekeeper:e.timekeeper})},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}s.status(500).send({error:"could not update",message:e.message})}).done()});router.post("/cluster-connection",function(e,s){var t=e.body.cluster;if(typeof t==="undefined"){s.status(400).send({error:"must have a cluster"});return}var r;try{r=index_1.Cluster.fromJS(t)}catch(e){s.status(400).send({error:"invalid cluster",message:e.message});return}config_1.SETTINGS_MANAGER.checkClusterConnectionInfo(r).then(function(e){s.send(e)},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}s.status(500).send({error:"could not compute",message:e.message})}).done()});router.get("/cluster-sources",function(e,s){config_1.SETTINGS_MANAGER.getAllClusterSources().then(function(e){s.send({clusterSources:e})},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}s.status(500).send({error:"could not compute",message:e.message})}).done()});router.post("/attributes",function(e,s){var t=e.body,r=t.source,n=t.cluster,o=t.clusterName;if(typeof r!=="string"){s.status(400).send({error:"must have a source"});return}var u=null;if(typeof o!=="string"){if(typeof n==="undefined"){s.status(400).send({error:"must have a clusterName or cluster"});return}try{u=index_1.Cluster.fromJS(n)}catch(e){s.status(400).send({error:"invalid cluster",message:e.message});return}}config_1.SETTINGS_MANAGER.getAllAttributes(r,u||o).then(function(e){s.send({attributes:e})},function(e){console.log("error:",e.message);if(e.hasOwnProperty("stack")){console.log(e.stack)}s.status(500).send({error:"could not compute",message:e.message})}).done()});router.post("/check-version",function(e,s){var t=e.body.settingsVersion;e.getFullSettings({expectedVersion:t}).then(function(e){var r=e.appSettings;var n=false;if(t<r.getVersion()){n=true}var o={};if(n)o.action="update";s.json(o)}).done()});module.exports=router;