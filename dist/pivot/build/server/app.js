"use strict";var path=require("path");var nike_hercules_1=require("@implydata/nike-hercules");var config_1=require("./config");var plywoodRoutes=require("./routes/plywood/plywood");var plyqlRoutes=require("./routes/plyql/plyql");var pivotRoutes=require("./routes/pivot/pivot");var collectionsRoutes=require("./routes/collections/collections");var settingsRoutes=require("./routes/settings/settings");var clientSettingsRoutes=require("./routes/client-settings/client-settings");var mkurlRoutes=require("./routes/mkurl/mkurl");var healthRoutes=require("./routes/health/health");var errorRoutes=require("./routes/error/error");var loginRoutes=require("./routes/login/login");var inviteUserRoutes=require("./routes/invite-user/invite-user");var passReset=require("./routes/pass-reset/pass-reset");var views_1=require("./views");var middleware_1=require("./utils/middleware/middleware");var user_1=require("../common/models/user/user");function makeGuardForSettings(){return function(e,r,s){var t=e.user;if(!(t instanceof user_1.User)){r.status(403).send({error:"no user"});return}if(!t.canAccessSettings()){r.status(403).send({error:"no settings access"});return}s()}}var server=new nike_hercules_1.HerculesServer({serverRoot:config_1.SERVER_SETTINGS.getServerRoot()});if(config_1.SERVER_SETTINGS.getTrustProxy()==="always"){server.getApp().set("trust proxy",1)}function addSettingsRoutes(e,r){var s=makeGuardForSettings();server.getApp().use(e,s,r);server.getApp().use(config_1.SERVER_SETTINGS.getServerRoot()+e,s,r)}server.addCompress();server.getApp().use(nike_hercules_1.logAndTrack(config_1.SERVER_SETTINGS.getRequestLogFormat()));if(config_1.SERVER_SETTINGS.getStrictTransportSecurity()==="always"){server.addHsts()}server.addRoutes("/health",healthRoutes);server.addStaticRoutes([path.join(__dirname,"../../build/public"),path.join(__dirname,"../../assets")]);server.addBodyParser();var stateful=config_1.SETTINGS_MANAGER.isStateful();var userMode=config_1.SERVER_SETTINGS.getUserMode();if(config_1.SERVER_SETTINGS.needsSession()){server.addSession(config_1.SERVER_SETTINGS.getSessionSecret(),config_1.SERVER_SETTINGS.getStrictTransportSecurity()!=="none",config_1.SERVER_SETTINGS.getSessionStore())}server.getApp().use(function(e,r,s){e.user=null;e.version=config_1.VERSION;e.stateful=stateful;e.userMode=userMode;e.getFullSettings=function(e){if(e===void 0){e={}}return config_1.SETTINGS_MANAGER.getFullSettings(e)};s()});server.getApp().use(function(e,r,s){var t=e.body.version;if(t&&t!==e.version){r.status(412).send({error:"incorrect version",action:"reload"});return}s()});server.getApp().use(function(e,r,s){var t=e.body.settingsVersion;if(t&&typeof t!=="number"){r.status(400).send({error:"settings version must be a number"});return}s()});if(config_1.AUTH&&config_1.SERVER_SETTINGS.externalUsers()){server.getApp().use(config_1.AUTH);server.getApp().use(function(e,r,s){if(e.user&&!(e.user instanceof user_1.User)){e.user=user_1.User.fromJS(e.user)}s()})}else if(stateful&&config_1.SERVER_SETTINGS.needsLogin()){server.addRoutes("/login",loginRoutes);server.addRoutes("/logout",middleware_1.logout);server.addRoutes("/invite-user",inviteUserRoutes);server.getApp().use(middleware_1.authenticatedOnly)}else if(userMode==="all-admin"){server.getApp().use(function(e,r,s){e.user=user_1.User.DEFAULT_ADMIN;s()})}server.addRoutes("/plywood",plywoodRoutes);server.addRoutes("/plyql",plyqlRoutes);server.addRoutes("/mkurl",mkurlRoutes);server.addRoutes("/error",errorRoutes);server.addRoutes("/client-settings",clientSettingsRoutes);if(stateful){server.addRoutes("/collections",collectionsRoutes);addSettingsRoutes("/settings",settingsRoutes);addSettingsRoutes("/pass-reset",passReset)}if(config_1.SERVER_SETTINGS.getIframe()==="deny"){server.getApp().use(function(e,r,s){r.setHeader("X-Frame-Options","DENY");r.setHeader("Content-Security-Policy","frame-ancestors 'none'");s()})}server.addRoutes("/",pivotRoutes);server.getApp().use(function(e,r,s){r.redirect("/")});if(server.getApp().get("env")==="development"){server.getApp().use(function(e,r,s,t){nike_hercules_1.LOGGER.error("Server Error: "+e.message);nike_hercules_1.LOGGER.error(e.stack);s.status(e.status||500);s.send(views_1.errorLayout({version:config_1.VERSION,title:"Error"},e.message,e))})}server.getApp().use(function(e,r,s,t){nike_hercules_1.LOGGER.error("Server Error: "+e.message);nike_hercules_1.LOGGER.error(e.stack);s.status(e.status||500);s.send(views_1.errorLayout({version:config_1.VERSION,title:"Error"},e.message))});module.exports=server;